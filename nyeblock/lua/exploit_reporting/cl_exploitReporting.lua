surface.CreateFont("menuFont",{font="Oswald",extended=false,size=30,weight=5000})
surface.CreateFont("nameFont",{font="Oswald",extended=false,size=28,weight=500})
surface.CreateFont("nameFont2",{font="Roboto Black",extended=false,size=30,weight=500})
surface.CreateFont("nameFont3",{font="Oswald",extended=false,size=24,weight=500})
surface.CreateFont("nameFont4",{font="Oswald",extended=false,size=18,weight=500})
surface.CreateFont("nameFont5",{font="Oswald",extended=false,size=20,weight=500})
surface.CreateFont("buttonFont",{font="Roboto Black",extended=false,size=25,weight=500})
surface.CreateFont("buttonFont2",{font="",extended=false,size=20,weight=500})
surface.CreateFont("applicationName",{font="Roboto Black",extended=false,size=35,weight=500})
surface.CreateFont("playerCount",{font="Roboto Black",extended=false,size=20,weight=500})
surface.CreateFont("buttonFont3",{font="Roboto Black",extended=false,size=15,weight=500})
surface.CreateFont("helpFont",{font="Roboto Black",extended=false,size=14,weight=500})
surface.CreateFont("helpFont2",{font="Roboto Black",extended=false,size=12,weight=500})

local popupTimeoutActive = false
local function createPopup(text,type)
	if !popupTimeoutActive then
		local popup = vgui.Create("DPanel")
		local lbl = vgui.Create("DLabel",popup)
		lbl:SetText(text)
		lbl:SetFont("buttonFont")
		lbl:SizeToContents()
		popup:SetSize(lbl:GetWide()+80,40)
		popup:SetPos(ScrW()/2-popup:GetWide()/2,ScrH())
		popup:MoveTo(ScrW()/2-popup:GetWide()/2,ScrH()-popup:GetTall()-5,.5,0,1)
		lbl:SetColor(Color(52,73,94))
		lbl:Center()
		function popup:Paint(w,h)
			draw.RoundedBox(0,0,0,w,h,Color(236,240,241))
			surface.SetDrawColor(149,165,166)
			surface.DrawOutlinedRect(0,0,w,h)
		end
		local icon = vgui.Create("DImage",popup)
		if type == 1 then
			icon:SetImage("icon16/tick.png")
		elseif type == 2 then
			icon:SetImage("icon16/error.png")
		elseif type == 3 then
			icon:SetImage("icon16/cross.png")
		end
		icon:SetSize(15,15)
		icon:SetPos(15,13)
		timer.Simple(5,function()
			popup:MoveTo(ScrW()/2-popup:GetWide()/2,ScrH(),.5,0,1)
			timer.Simple(2,function()
				popup:Remove()
			end)
		end)
		popupTimeoutActive = true
		timer.Simple(2,function()
			popupTimeoutActive = false
		end)
	end
end

net.Receive("ers_panel",function()
	local reports = net.ReadTable()

	local panel = vgui.Create("DFrame")
	panel:SetSize(900,600)
	panel:Center()
	panel:SetTitle("")
	panel:SetDraggable(false)
	panel:ShowCloseButton(false)
	panel:MakePopup()
	function panel:Paint(w,h)
		draw.RoundedBox(0,0,40,w,h-40,Color(189,195,199))
		surface.SetDrawColor(149,165,166)
		surface.DrawOutlinedRect(0,40,w,h-40)
	end
	local close = vgui.Create("DButton",panel)
	close:SetSize(100,30)
	close:SetPos(panel:GetWide()-close:GetWide(),0)
	close:SetText("")
	function close:Paint(w,h)
		draw.RoundedBox(0,0,0,w,h,Color(236,240,241))
		surface.SetDrawColor(149,165,166)
		surface.DrawOutlinedRect(0,0,w,h)
	end
	function close:DoClick()
		panel:Close()
	end
	local closet = vgui.Create("DLabel",close)
	closet:SetText("CLOSE")
	closet:SetFont("nameFont5")
	closet:SetColor(Color(52,73,94))
	closet:SizeToContents()
	closet:Center()
	local header = vgui.Create("DPanel",panel)
	header:SetSize(panel:GetWide(),65)
	header:SetPos(0,40)
	function header:Paint(w,h)
		draw.RoundedBox(0,0,0,w,h,Color(236,240,241))
		surface.SetDrawColor(149,165,166)
		surface.DrawOutlinedRect(0,0,w,h)
	end
	local logo = vgui.Create("DImage",header)
	logo:SetImage("materials/nb/logo.png")
	logo:SetSize(100,100)
	logo:SetPos(0,-17)
	local lbl = vgui.Create("DLabel",header)
	lbl:SetText("Exploit Report System")
	lbl:SetFont("menuFont")
	lbl:SetColor(Color(52,73,94))
	lbl:SizeToContents()
	lbl:SetPos(95,0)
	lbl:CenterVertical()
	local pagepanel = vgui.Create("DScrollPanel",panel)
	pagepanel:SetSize(panel:GetWide()-40,455)
	pagepanel:SetPos(20,125)
	function pagepanel:Paint(w,h)
		draw.RoundedBox(0,0,0,w,h,Color(236,240,241))
		surface.SetDrawColor(149,165,166)
		surface.DrawOutlinedRect(0,0,w,h)
	end
	local function center(i,y)
		i:SetPos(pagepanel:GetWide()/2-i:GetWide()/2,y)
	end
	function ers_admin()
		local reports = {}
		pagepanel:AlphaTo(255,.5,0)

		net.Start("ers_getAllReports")
		net.SendToServer()

		local function page()
			local lbl = vgui.Create("DLabel",pagepanel)
			lbl:SetText("Reports")
			lbl:SetFont("nameFont")
			lbl:SetColor(Color(52,73,94))
			lbl:SizeToContents()
			center(lbl,10)
			local back = vgui.Create("DButton",pagepanel)
			back:SetSize(100,25)
			back:SetText("")
			back:SetPos(10,10)
			function back:Paint() end
			function back:DoClick()
				pagepanel:SetAlpha(0)
				pagepanel:Clear()
				ers_home()
			end
			local img = vgui.Create("DImage",back)
			img:SetImage("icon16/arrow_left.png")
			img:SetSize(25,25)
			img:SetPos(10,0)
			img:CenterVertical()
			local lbl = vgui.Create("DLabel",back)
			lbl:SetText("Go Back")
			lbl:SetFont("buttonFont3")
			lbl:SetColor(Color(52,73,94))
			lbl:SizeToContents()
			lbl:SetPos(40,0)
			lbl:CenterVertical()
			local reportsList = vgui.Create("DListView",pagepanel)
			reportsList:SetSize(pagepanel:GetWide()-80,150)
			reportsList:SetPos(0,50)
			reportsList:CenterHorizontal()
			reportsList:AddColumn("Name")
			reportsList:AddColumn("Map")
			reportsList:AddColumn("Submitted")
			reportsList:SortByColumn(3)
			for k,v in pairs(reports) do
				reportsList:AddLine(v.name,v.map,os.date("%m/%d/%Y",v.submitted))
				if v.status == 2 then
					reportsList:GetLine(k).Paint = function(_,w,h)
						draw.RoundedBox(0,0,0,w,h,Color(0,255,0,255))
					end
				elseif v.status == 3 then
					reportsList:GetLine(k).Paint = function(_,w,h)
						draw.RoundedBox(0,0,0,w,h,Color(255,0,0,255))
					end
				end
			end
			local view = vgui.Create("DButton",pagepanel)
			view:SetSize(150,30)
			view:SetPos(0,220)
			view:CenterHorizontal()
			view:SetText("")
			function view:Paint(w,h)
				draw.RoundedBox(0,0,0,w,h,Color(236,240,241))
				surface.SetDrawColor(149,165,166)
				surface.DrawOutlinedRect(0,0,w,h)
			end
			local lbl = vgui.Create("DLabel",view)
			lbl:SetText("View selected report")
			lbl:SetFont("buttonFont3")
			lbl:SetColor(Color(52,73,94))
			lbl:SizeToContents()
			lbl:Center()
			function view:DoClick()
				local selected = reportsList:GetSelectedLine()
				if selected != nil then
					local function viewImage(reportId,imageId)
						local imageData = ""

						net.Start("ers_getImage")
							net.WriteString(reportId)
							net.WriteString(imageId)
						net.SendToServer()

						local viewImage = vgui.Create("DPanel")
						viewImage:SetSize(ScrW(),ScrH())
						viewImage:Center()
						viewImage:MakePopup()
						function viewImage:Paint() end
						local blur = vgui.Create("DFrame",viewImage)
						blur:SetSize(1,1)
						blur:SetBackgroundBlur(true)
						local close = vgui.Create("DImageButton",viewImage)
						close:SetSize(50,50)
						close:SetImage("icon16/cross.png")
						close:SetPos(viewImage:GetWide()-60,10)
						function close:DoClick()
							viewImage:Remove()
						end
						local loading = vgui.Create("DLabel",viewImage)
						loading:SetText("Retrieving image data...")
						loading:SetFont("playerCount")
						loading:SetColor(Color(255,255,255))
						loading:SizeToContents()
						loading:Center()

						net.Receive("ers_returnImage",function()
							local totalData = net.ReadString()
							for i=1,63 do
								local chunkLength = net.ReadString()
								if chunkLength != "" and isnumber(tonumber(chunkLength)) then
									local chunk = net.ReadData(chunkLength)

									imageData = imageData..chunk
								end
							end

							if #imageData >= tonumber(totalData) then
								loading:Remove()

								local img = vgui.Create("HTML",viewImage)
								img:SetSize(viewImage:GetWide()-50,viewImage:GetTall()-50)
								img:SetPos(20,60)
								img:SetHTML([[<img width="]]..(ScrW()-60)..[[" height="]]..(ScrH()-100)..[[" src="data:image/jpeg;base64, ]]..util.Decompress(imageData)..[["/>]])
							else
								net.Start("ers_imageChunkReady")
								net.SendToServer()
							end
						end)
					end

					local box = vgui.Create("DPanel",pagepanel)
					box:SetSize(400,290)
					center(box,pagepanel:GetTall()/2-box:GetTall()/2)
					function box:Paint(w,h)
						draw.RoundedBox(0,0,0,w,h,Color(236,240,241))
						surface.SetDrawColor(149,165,166)
						surface.DrawOutlinedRect(0,0,w,h)
					end
					box:SetPos(0,pagepanel:GetVBar():GetScroll()+pagepanel:GetTall()/2-box:GetTall()/2)
					box:CenterHorizontal()
					local close = vgui.Create("DImageButton",box)
					close:SetSize(15,15)
					close:SetImage("icon16/cross.png")
					close:SetPos(box:GetWide()-close:GetWide()-10,10)
					function close:DoClick()
						box:Remove()
					end
					local lbl = vgui.Create("DLabel",box)
					lbl:SetText("View Report")
					lbl:SetFont("buttonFont")
					lbl:SetColor(Color(52,73,94))
					lbl:SizeToContents()
					lbl:SetPos(0,10)
					lbl:CenterHorizontal()
					local lbl = vgui.Create("DLabel",box)
					lbl:SetText(reports[selected].map)
					lbl:SetFont("buttonFont3")
					lbl:SetColor(Color(52,73,94))
					lbl:SizeToContents()
					lbl:SetPos(0,40)
					lbl:CenterHorizontal()
					local lbl = vgui.Create("DLabel",box)
					lbl:SetText(os.date("%m/%d/%Y",reports[selected].submitted))
					lbl:SetFont("buttonFont3")
					lbl:SetColor(Color(52,73,94))
					lbl:SizeToContents()
					lbl:SetPos(0,60)
					lbl:CenterHorizontal()
					local lbl = vgui.Create("DLabel",box)
					lbl:SetText("Description:")
					lbl:SetFont("buttonFont3")
					lbl:SetColor(Color(52,73,94))
					lbl:SizeToContents()
					lbl:SetPos(0,90)
					lbl:CenterHorizontal()
					local description = vgui.Create("DTextEntry",box)
					description:SetSize(box:GetWide()-40,75)
					description:SetPos(0,110)
					description:CenterHorizontal()
					description:SetMultiline(true)
					description:SetValue(reports[selected].description)
					description:SetVerticalScrollbarEnabled(true)
					description:SetDisabled(true)
					local lbl = vgui.Create("DLabel",box)
					lbl:SetText("Images:")
					lbl:SetFont("buttonFont3")
					lbl:SetColor(Color(52,73,94))
					lbl:SizeToContents()
					lbl:SetPos(0,195)
					lbl:CenterHorizontal()
					local images = vgui.Create("DIconLayout",box)
					images:SetWide(box:GetWide()-20)
					images:SetPos(0,215)
					images:SetSpaceX(10)
					images:CenterHorizontal()
					for k,v in pairs(reports[selected].images) do
						local img = images:Add("DPanel")
						img:SetSize(115,25)
						function img:Paint(w,h)
							draw.RoundedBox(0,0,0,w,h,Color(236,240,241))
							surface.SetDrawColor(149,165,166)
							surface.DrawOutlinedRect(0,0,w,h)
						end
						local lbl = vgui.Create("DLabel",img)
						lbl:SetText("View image "..k)
						lbl:SetFont("buttonFont3")
						lbl:SetColor(Color(52,73,94))
						lbl:SizeToContents()
						lbl:Center()
						local buttonClick = vgui.Create("DButton",img)
						buttonClick:SetSize(img:GetWide(),img:GetTall())
						buttonClick:SetText("")
						function buttonClick:Paint() end
						function buttonClick:DoClick()
							viewImage(reports[selected].id,k)
						end
					end
					local patched = vgui.Create("DButton",box)
					patched:SetSize(180,25)
					patched:SetPos(15,255)
					patched:SetText("")
					function patched:Paint(w,h)
						draw.RoundedBox(0,0,0,w,h,Color(236,240,241))
						surface.SetDrawColor(149,165,166)
						surface.DrawOutlinedRect(0,0,w,h)
					end
					function patched:DoClick()
						net.Start("ers_updateReportStatus")
							net.WriteString(selected)
							net.WriteString(2)
						net.SendToServer()

						createPopup("The reports status has been updated!",1)
					end
					local lbl = vgui.Create("DLabel",patched)
					lbl:SetText("Mark as patched")
					lbl:SetFont("buttonFont3")
					lbl:SetColor(Color(52,73,94))
					lbl:SizeToContents()
					lbl:Center()
					local closed = vgui.Create("DButton",box)
					closed:SetSize(180,25)
					closed:SetPos(205,255)
					closed:SetText("")
					function closed:Paint(w,h)
						draw.RoundedBox(0,0,0,w,h,Color(236,240,241))
						surface.SetDrawColor(149,165,166)
						surface.DrawOutlinedRect(0,0,w,h)
					end
					function closed:DoClick()
						net.Start("ers_updateReportStatus")
							net.WriteString(selected)
							net.WriteString(3)
						net.SendToServer()

						createPopup("The reports status has been updated!",1)
					end
					local lbl = vgui.Create("DLabel",closed)
					lbl:SetText("Mark as closed")
					lbl:SetFont("buttonFont3")
					lbl:SetColor(Color(52,73,94))
					lbl:SizeToContents()
					lbl:Center()
				end
			end
		end

		net.Receive("ers_returnAllReports",function()
			reports = net.ReadTable()
			pagepanel:Clear()
			page()
		end)
	end
	function ers_createReport()
		local imagesAttached = {}

		pagepanel:AlphaTo(255,.5,0)
		local lbl = vgui.Create("DLabel",pagepanel)
		lbl:SetText("Create an exploit report")
		lbl:SetFont("nameFont")
		lbl:SetColor(Color(52,73,94))
		lbl:SizeToContents()
		center(lbl,10)
		local back = vgui.Create("DButton",pagepanel)
		back:SetSize(100,25)
		back:SetText("")
		back:SetPos(10,10)
		function back:Paint() end
		function back:DoClick()
			pagepanel:SetAlpha(0)
			pagepanel:Clear()
			ers_home()
		end
		local img = vgui.Create("DImage",back)
		img:SetImage("icon16/arrow_left.png")
		img:SetSize(25,25)
		img:SetPos(10,0)
		img:CenterVertical()
		local lbl = vgui.Create("DLabel",back)
		lbl:SetText("Go Back")
		lbl:SetFont("buttonFont3")
		lbl:SetColor(Color(52,73,94))
		lbl:SizeToContents()
		lbl:SetPos(40,0)
			lbl:CenterVertical()
		local lbl = vgui.Create("DLabel",pagepanel)
		lbl:SetText("What map does this exploit occur on?")
		lbl:SetFont("nameFont5")
		lbl:SetColor(Color(52,73,94))
		lbl:SizeToContents()
		center(lbl,50)
		local map = vgui.Create("DLabel",pagepanel)
		map:SetText(game.GetMap())
		map:SetFont("nameFont5")
		map:SetColor(Color(52,73,94))
		map:SizeToContents()
		center(map,80)
		local lbl = vgui.Create("DLabel",pagepanel)
		lbl:SetText("Short description of the exploit.")
		lbl:SetFont("nameFont5")
		lbl:SetColor(Color(52,73,94))
		lbl:SizeToContents()
		center(lbl,120)
		local description = vgui.Create("DTextEntry",pagepanel)
		description:SetSize(350,75)
		description:SetMultiline(true)
		center(description,150)
		local wordcount = vgui.Create("DLabel",pagepanel)
		wordcount:SetText("")
		wordcount:SetFont("nameFont4")
		wordcount:SetColor(Color(52,73,94))
		wordcount:SizeToContents()
		wordcount:SetPos(255,225)
		function description:OnChange()
			wordcount:SetText("( "..string.len(description:GetText()).." / 500 )")
			wordcount:SizeToContents()
		end
		local lbl = vgui.Create("DLabel",pagepanel)
		lbl:SetText("Images of the exploit.")
		lbl:SetFont("nameFont5")
		lbl:SetColor(Color(52,73,94))
		lbl:SizeToContents()
		center(lbl,240)
		local addImage = vgui.Create("DButton",pagepanel)
		addImage:SetSize(150,30)
		addImage:SetText("")
		addImage:SetPos(pagepanel:GetWide()/2+addImage:GetWide()/2,235)
		function addImage:Paint(w,h)
			draw.RoundedBox(0,0,0,w,h,Color(236,240,241))
			surface.SetDrawColor(149,165,166)
			surface.DrawOutlinedRect(0,0,w,h)
		end
		local images = vgui.Create("DIconLayout",pagepanel)
		images:SetSize(630,100)
		images:SetSpaceX(10)
		center(images,270)
		function addImage:DoClick()
			local imageData
			local imageRequested = false

			if #imagesAttached < 3 then
				panel:SetVisible(false)
				
				local focusPnl = vgui.Create("DPanel")
				focusPnl:SetSize(1,1)
				focusPnl:MakePopup()
				focusPnl:SetMouseInputEnabled(false)
				function focusPnl:Paint() end
				local lbl = vgui.Create("DLabel")
				lbl:SetText("You are adding an image to your exploit report. Press h to take a screenshot of current view. Press k to cancel.")
				lbl:SetFont("nameFont5")
				lbl:SetColor(Color(255,255,255))
				lbl:SizeToContents()
				lbl:SetPos(0,35)
				lbl:CenterHorizontal()
				hook.Add("Think","ers_allowMovement",function()
					if input.IsKeyDown(KEY_W) or input.IsKeyDown(KEY_A) or input.IsKeyDown(KEY_S) or input.IsKeyDown(KEY_D) then
						if IsValid(focusPnl) then
							focusPnl:SetKeyboardInputEnabled(false)
							timer.Simple(1,function()
								if IsValid(focusPnl) then
									focusPnl:SetKeyboardInputEnabled(true)
								end
							end)
						end
					end
				end)
				hook.Add("PostRender","ers_getScreen",function()
					if imageRequested and imageData == nil then
						imageData = render.Capture({
							format = "jpeg",
							quality = 70,
							h = ScrH(),
							w = ScrW(),
							x = 0,
							y = 0,
						})
					end
				end)
				function focusPnl:OnKeyCodePressed(key)
					if key == KEY_H then
						lbl:Remove()
						imageRequested = true
						timer.Simple(.5,function()
							local position = 0
							for i=1,3 do
								if imagesAttached[i] == nil then
									position = i
									break
								end
							end

							focusPnl:Remove()
							panel:SetVisible(true)
							hook.Remove("Think","ers_allowMovement")
							hook.Remove("PostRender","ers_getScreen")

							local box = vgui.Create("DPanel",pagepanel)
							box:SetSize(400,285)
							box:Center()
							function box:Paint(w,h)
								draw.RoundedBox(0,0,0,w,h,Color(236,240,241))
								surface.SetDrawColor(149,165,166)
								surface.DrawOutlinedRect(0,0,w,h)
							end
							box:SetPos(0,pagepanel:GetVBar():GetScroll()+pagepanel:GetTall()/2-box:GetTall()/2)
							box:CenterHorizontal()
							local close = vgui.Create("DImageButton",box)
							close:SetSize(15,15)
							close:SetImage("icon16/cross.png")
							close:SetPos(box:GetWide()-close:GetWide()-10,10)
							function close:DoClick()
								box:Remove()
							end
							local lbl = vgui.Create("DLabel",box)
							lbl:SetText("Add Image")
							lbl:SetFont("buttonFont")
							lbl:SetColor(Color(52,73,94))
							lbl:SizeToContents()
							lbl:SetPos(0,10)
							lbl:CenterHorizontal()
							local lbl = vgui.Create("DLabel",box)
							lbl:SetText("Is this screenshot okay?")
							lbl:SetFont("nameFont5")
							lbl:SetColor(Color(52,73,94))
							lbl:SizeToContents()
							lbl:SetPos(0,35)
							lbl:CenterHorizontal()
							local img = vgui.Create("HTML",box)
							img:SetSize(box:GetWide()-20,175)
							img:SetPos(10,60)
							img:SetHTML([[<img width="360" height="155" src="data:image/jpeg;base64, ]]..util.Base64Encode(imageData)..[["/>]])
							local yes = vgui.Create("DButton",box)
							yes:SetSize(100,30)
							yes:SetPos(65,245)
							yes:SetText("")
							function yes:Paint(w,h)
								draw.RoundedBox(0,0,0,w,h,Color(236,240,241))
								surface.SetDrawColor(149,165,166)
								surface.DrawOutlinedRect(0,0,w,h)
							end
							function yes:DoClick()
								box:Remove()
								table.insert(imagesAttached, position, util.Compress(util.Base64Encode(imageData)))

								local pnl = images:Add("DPanel")
								pnl:SetSize(200,125)
								function pnl:Paint() end
								local img = vgui.Create("HTML",pnl)
								img:SetSize(pnl:GetWide()-2,pnl:GetTall()-2)
								img:SetPos(1,1)
								img:SetHTML([[<img width="185" height="98" src="data:image/jpeg;base64, ]]..util.Base64Encode(imageData)..[["/>]])
								local remove = vgui.Create("DImageButton",pnl)
								remove:SetSize(15,15)
								remove:SetImage("icon16/cross.png")
								remove:SetTooltip("Remove this image")
								remove:SetPos(pnl:GetWide()-remove:GetWide(),0)
								function remove:DoClick()
									pnl:Remove()
									imagesAttached[position] = nil
								end
							end
							local lbl = vgui.Create("DLabel",yes)
							lbl:SetText("Yes")
							lbl:SetFont("playerCount")
							lbl:SetColor(Color(52,73,94))
							lbl:SizeToContents()
							lbl:Center()
							local no = vgui.Create("DButton",box)
							no:SetSize(100,30)
							no:SetPos(235,245)
							no:SetText("")
							function no:Paint(w,h)
								draw.RoundedBox(0,0,0,w,h,Color(236,240,241))
								surface.SetDrawColor(149,165,166)
								surface.DrawOutlinedRect(0,0,w,h)
							end
							function no:DoClick()
								box:Remove()
							end
							local lbl = vgui.Create("DLabel",no)
							lbl:SetText("No")
							lbl:SetFont("playerCount")
							lbl:SetColor(Color(52,73,94))
							lbl:SizeToContents()
							lbl:Center()
						end)
					elseif key == KEY_K then
						lbl:Remove()
						focusPnl:Remove()
						panel:SetVisible(true)
						hook.Remove("Think","ers_allowMovement")
						hook.Remove("PostRender","ers_getScreen")
					end
				end
			else
				createPopup("You can only add up to 3 images!",3)
			end
		end
		local lbl = vgui.Create("DLabel",addImage)
		lbl:SetText("+ Add Image")
		lbl:SetFont("buttonFont3")
		lbl:SetColor(Color(52,73,94))
		lbl:SizeToContents()
		lbl:Center()
		local submit = vgui.Create("DButton",pagepanel)
		submit:SetSize(150,30)
		submit:SetText("")
		center(submit,410)
		function submit:Paint(w,h)
			draw.RoundedBox(0,0,0,w,h,Color(236,240,241))
			surface.SetDrawColor(149,165,166)
			surface.DrawOutlinedRect(0,0,w,h)
		end
		function submit:DoClick()
			if string.len(description:GetValue()) == 0 then
				createPopup("The description field is required!",2)
			elseif string.len(description:GetValue()) > 500 then
				createPopup("The description field only has a max character count of 500!",2)
			elseif #imagesAttached == 0 then
				createPopup("Atleast one image is required!",2)
			else
				local data = {
					steamid64 = LocalPlayer():SteamID64(),
					map = game.GetMap(),
					description = description:GetValue(),
					images = {}
				}

				net.Start("ers_createReport")
					net.WriteTable(data)
					net.WriteString(#imagesAttached)
				net.SendToServer()
				net.Receive("ers_startImageSave",function()
					local reportId = net.ReadString()
					local totalImages = #imagesAttached
					local completedImages = 0

					local function processImage()
						if !file.Exists("ers/cachedImages/"..reportId.."/"..completedImages+1,"DATA") then
							file.CreateDir("ers/cachedImages")
							file.Write("ers/cachedImages/"..reportId.."/"..completedImages+1,imagesAttached[completedImages+1])
						
						end
						if totalImages != completedImages then
							local imageData = imagesAttached[completedImages + 1]
							local chunks = #imageData/1024
							local posMin = 0
							local posMax = 1024

							local function sendNextChunk()
								net.Start("ers_saveImage")
									net.WriteString(reportId)
									net.WriteString(completedImages + 1)
									net.WriteString(#imageData)
									for i=1,61 do
										local chunk = string.sub(imageData,posMin,posMax)

										net.WriteString(#chunk)
										net.WriteData(chunk,#chunk)

										posMin = posMin + 1025
										posMax = posMax + 1025
									end
								net.SendToServer()
							end
							net.Receive("ers_imageChunkReady",function()
								sendNextChunk()
							end)
							sendNextChunk()
						end
					end

					net.Receive("ers_imageReady",function()
						completedImages = completedImages + 1
						processImage()
					end)
					processImage()
				end)

				createPopup("Your report has been created!",1)
				timer.Simple(2,function()
					createPopup("Please wait a few minutes for your image(s) to upload!",2)
				end)

				pagepanel:Clear()
				pagepanel:SetAlpha(0)
				ers_home()
			end
		end
		local lbl = vgui.Create("DLabel",submit)
		lbl:SetText("Submit report")
		lbl:SetFont("buttonFont3")
		lbl:SetColor(Color(52,73,94))
		lbl:SizeToContents()
		lbl:Center()
	end
	function ers_home()
		pagepanel:AlphaTo(255,.5,0)
		local create = vgui.Create("DButton",pagepanel)
		create:SetSize(150,30)
		create:SetText("")
		create:SetPos(pagepanel:GetWide()/2+create:GetWide()/1.5,10)
		function create:Paint(w,h)
			draw.RoundedBox(0,0,0,w,h,Color(236,240,241))
			surface.SetDrawColor(149,165,166)
			surface.DrawOutlinedRect(0,0,w,h)
		end
		function create:DoClick()
			pagepanel:Clear()
			pagepanel:SetAlpha(0)
			ers_createReport()
		end
		local lbl = vgui.Create("DLabel",create)
		lbl:SetText("+ New Report")
		lbl:SetFont("buttonFont3")
		lbl:SetColor(Color(52,73,94))
		lbl:SizeToContents()
		lbl:Center()
		local lbl = vgui.Create("DLabel",pagepanel)
		lbl:SetText("Your reported exploits")
		lbl:SetFont("nameFont")
		lbl:SetColor(Color(52,73,94))
		lbl:SizeToContents()
		center(lbl,10)
		local reportLayout = vgui.Create("DIconLayout",pagepanel)
		reportLayout:SetWide(pagepanel:GetWide()-40)
		reportLayout:SetSpaceX(40)
		reportLayout:SetSpaceY(10)
		center(reportLayout,50)
		if table.Count(reports) > 0 then
			for k,v in pairs(reports) do
				local pnl = reportLayout:Add("DPanel")
				pnl:SetSize(390,65)
				function pnl:Paint(w,h)
					draw.RoundedBox(0,0,0,w,h,Color(236,240,241))
					draw.RoundedBox(0,0,0,15,h,Color(149,165,166))
					surface.SetDrawColor(149,165,166)
					surface.DrawOutlinedRect(0,0,w,h)
				end
				local lbl = vgui.Create("DLabel",pnl)
				lbl:SetText(v.map.." Exploit Report")
				lbl:SetFont("nameFont5")
				lbl:SetColor(Color(52,73,94))
				lbl:SizeToContents()
				lbl:SetPos(30,2)
				local img = vgui.Create("DImage",pnl)
				img:SetImage("icon16/calendar.png")
				img:SetSize(15,15)
				img:SetPos(30,25)
				local img = vgui.Create("DImage",pnl)
				img:SetImage("icon16/picture.png")
				img:SetSize(15,15)
				img:SetPos(30,45)
				local lbl = vgui.Create("DLabel",pnl)
				lbl:SetText(#v.images.." image(s)")
				lbl:SetFont("nameFont5")
				lbl:SetColor(Color(52,73,94))
				lbl:SizeToContents()
				lbl:SetPos(50,43)
				local lbl = vgui.Create("DLabel",pnl)
				lbl:SetText(os.date("%m/%d/%Y",v.submitted))
				lbl:SetFont("nameFont5")
				lbl:SetColor(Color(52,73,94))
				lbl:SizeToContents()
				lbl:SetPos(50,23)
				local status = vgui.Create("DImageButton",pnl)
				if v.status == 1 then
					status:SetImage("icon16/time.png")
					status:SetTooltip("Under Review")
				elseif v.status == 2 then
					status:SetImage("icon16/tick.png")
					status:SetTooltip("Patched")
				else
					status:SetImage("icon16/cross.png")
					status:SetTooltip("Closed")
				end
				status:SetSize(20,20)
				status:SetPos(pnl:GetWide()-50,0)
				status:CenterVertical()
			end
		else
			local pnl = reportLayout:Add("DPanel")
			pnl:SetSize(reportLayout:GetWide(),50)
			function pnl:Paint() end
			local lbl = vgui.Create("DLabel",pnl)
			lbl:SetText("You don't have any created reports.")
			lbl:SetFont("buttonFont3")
			lbl:SetColor(Color(52,73,94))
			lbl:SizeToContents()
			lbl:Center()
		end
	end
	if ap_isAdmin(LocalPlayer():GetUserGroup()) then
		local admin = vgui.Create("DButton",panel)
		admin:SetSize(30,30)
		admin:SetPos(panel:GetWide()-close:GetWide()-admin:GetWide()-10,0)
		admin:SetText("")
		admin:SetTooltip("Reports")
		function admin:Paint(w,h)
			draw.RoundedBox(0,0,0,w,h,Color(236,240,241))
			surface.SetDrawColor(149,165,166)
			surface.DrawOutlinedRect(0,0,w,h)
		end
		function admin:DoClick()
			pagepanel:Clear()
			pagepanel:SetAlpha(0)
			ers_admin()
		end
		local adminimg = vgui.Create("DImage",admin)
		adminimg:SetImage("icon16/page_white_stack.png")
		adminimg:SetSize(15,15)
		adminimg:Center()
	end
	ers_home()
end)